<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸ“œ Order History - SpicyPOS</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <link rel="stylesheet" href="../styles/OrderHistory.css">

</head>
<body>

<button class="toggle-sidebar" onclick="toggleSidebar()">
  <i class="fas fa-bars"></i>
</button>

<nav class="sidebar" id="sidebar">
  <div class="logo">
    <i class="fas fa-pepper-hot"></i>
    <h2>SpicyPOS</h2>
  </div>
  <ul class="nav-menu">
    <li class="nav-item"><a href="../Index.html" class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
    <li class="nav-item"><a href="Customer.html" class="nav-link"><i class="fas fa-users"></i><span>Customers</span></a></li>
    <li class="nav-item"><a href="Item.html" class="nav-link"><i class="fas fa-utensils"></i><span>Manage Items</span></a></li>
    <li class="nav-item"><a href="Order.html" class="nav-link"><i class="fas fa-shopping-cart"></i><span>Place Order</span></a></li>
    <li class="nav-item"><a href="OrderHistory.html" class="nav-link active"><i class="fas fa-history"></i><span>Order History</span></a></li>
    <li class="nav-item"><a href="#" class="nav-link"><i class="fas fa-chart-line"></i><span>Analytics</span></a></li>
  </ul>
  <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
</nav>

<main class="main-content">
  <div class="header">
    <div class="header-left">
      <h1><i class="fas fa-history"></i> Order History</h1>
      <p>View and manage all past orders</p>
    </div>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <i class="fas fa-shopping-bag"></i>
      <div class="stat-value" id="total-orders">0</div>
      <div class="stat-label">Total Orders</div>
    </div>
    <div class="stat-card">
      <i class="fas fa-rupee-sign"></i>
      <div class="stat-value" id="total-revenue">LKR 0.00</div>
      <div class="stat-label">Total Revenue</div>
    </div>
    <div class="stat-card">
      <i class="fas fa-users"></i>
      <div class="stat-value" id="total-customers">0</div>
      <div class="stat-label">Unique Customers</div>
    </div>
  </div>

  <!-- Filter Card -->
  <div class="filter-card">
    <div class="form-title"><i class="fas fa-filter"></i> Filter Orders</div>
    <div class="filter-grid">
      <div class="form-group">
        <label>From Date</label>
        <input type="date" id="filter-from-date">
      </div>
      <div class="form-group">
        <label>To Date</label>
        <input type="date" id="filter-to-date">
      </div>
      <div class="form-group">
        <label>Customer</label>
        <select id="filter-customer">
          <option value="">All Customers</option>
        </select>
      </div>
      <div class="form-group" style="display: flex; gap: 12px; align-self: end; flex-wrap: wrap;">
        <button class="btn btn-filter" onclick="filterOrders()">
          <i class="fas fa-search"></i> <span>Filter</span>
        </button>
        <button class="btn btn-clear" onclick="clearFilters()">
          <i class="fas fa-undo"></i> <span>Clear</span>
        </button>
        <button class="btn btn-refresh" onclick="loadAllOrders()">
          <i class="fas fa-sync"></i> <span>Refresh</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Order Table -->
  <div class="table-card">
    <div class="table-title"><i class="fas fa-table"></i> Order List</div>
    <div class="table-container">
      <table id="order-table">
        <thead>
        <tr>
          <th>Order ID</th>
          <th>Order Date</th>
          <th>Customer ID</th>
          <th>Customer Name</th>
          <th>Total (LKR)</th>
          <th style="text-align: center;">Actions</th>
        </tr>
        </thead>
        <tbody id="order-table-body">
        <tr class="no-data"><td colspan="6">Loading orders...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>


<script src="../js/jquery-3.7.1.min.js"></script>
<script>

  let allOrders = [];
  let customers = [];

  $(document).ready(function() {
    loadCustomersForFilter();
    loadAllOrders();
  });

  function showToast(type, title, message) {
    const toast = $(`
      <div class="toast ${type}">
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <div class="toast-content">
          <h4>${title}</h4>
          <p>${message}</p>
        </div>
      </div>
    `);
    $('body').append(toast);
    setTimeout(() => toast.fadeOut(400, () => toast.remove()), 3000);
  }

  function loadCustomersForFilter() {
    $.ajax({
      url: 'http://localhost:8080/JavaEE_POS_my_Web5_exploded/customer',
      method: 'GET',
      dataType: 'json',
      success: function(response) {
        customers = response;
        $('#filter-customer').empty().append('<option value="">All Customers</option>');
        response.forEach(c => {
          $('#filter-customer').append(`<option value="${c.cid}">${c.cid} - ${c.cname}</option>`);
        });
      },
      error: function() {
        showToast('error', 'Error', 'Failed to load customers for filter');
      }
    });
  }

  function loadAllOrders() {
    $('#order-table-body').html('<tr class="no-data"><td colspan="6"><i class="fas fa-spinner fa-spin"></i><br>Loading orders...</td></tr>');

    $.ajax({
      url: 'http://localhost:8080/JavaEE_POS_my_Web5_exploded/order',
      method: 'GET',
      dataType: 'json',
      success: function(orders) {
        allOrders = orders;
        displayOrders(orders);
        updateStats(orders);
      },
      error: function(xhr) {
        $('#order-table-body').html('<tr class="no-data"><td colspan="6"><i class="fas fa-exclamation-triangle"></i><br>Failed to load orders<br><small>' + (xhr.responseText || 'Server error') + '</small></td></tr>');
        showToast('error', 'Load Failed', 'Could not fetch orders from server');
      }
    });
  }

  function displayOrders(orders) {
    $('#order-table-body').empty();
    if (orders.length === 0) {
      $('#order-table-body').html('<tr class="no-data"><td colspan="6"><i class="fas fa-inbox"></i><br>No orders found</td></tr>');
      return;
    }

    orders.forEach(order => {
      const customer = customers.find(c => c.cid === order.customerId);
      const customerName = customer ? customer.cname : 'N/A';

      const row = `
        <tr>
          <td>${order.orderId}</td>
          <td>${formatDate(order.orderDate)}</td>
          <td>${order.customerId}</td>
          <td>${customerName}</td>
          <td class="currency">LKR ${formatCurrency(order.total || 0)}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-view" onclick="viewOrderDetails('${order.orderId}')">
                <i class="fas fa-eye"></i> <span>View</span>
              </button>
              <button class="btn btn-delete" onclick="deleteOrder('${order.orderId}')">
                <i class="fas fa-trash"></i> <span>Delete</span>
              </button>
            </div>
          </td>
        </tr>`;
      $('#order-table-body').append(row);
    });
  }

  function filterOrders() {
    let filtered = allOrders;

    const fromDate = $('#filter-from-date').val();
    const toDate = $('#filter-to-date').val();
    const customerId = $('#filter-customer').val();

    if (fromDate) filtered = filtered.filter(o => o.orderDate >= fromDate);
    if (toDate) filtered = filtered.filter(o => o.orderDate <= toDate);
    if (customerId) filtered = filtered.filter(o => o.customerId === customerId);

    displayOrders(filtered);
  }

  function clearFilters() {
    $('#filter-from-date').val('');
    $('#filter-to-date').val('');
    $('#filter-customer').val('');
    displayOrders(allOrders);
  }

  function updateStats(orders) {
    const totalOrders = orders.length;
    const totalRevenue = orders.reduce((sum, o) => sum + (parseFloat(o.total) || 0), 0);
    const uniqueCustomers = new Set(orders.map(o => o.customerId)).size;

    $('#total-orders').text(totalOrders);
    $('#total-revenue').text('LKR ' + formatCurrency(totalRevenue));
    $('#total-customers').text(uniqueCustomers);
  }

  function formatCurrency(value) {
    return parseFloat(value || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const date = new Date(dateStr);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function viewOrderDetails(orderId) {
    alert('View Order Details for: ' + orderId + '\n(This feature can be expanded with a modal showing order items)');
    // You can later implement a modal to show order items
  }

  function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete order ' + orderId + '?')) {
      $.ajax({
        url: 'http://localhost:8080/JavaEE_POS_my_Web5_exploded/order?orderId=' + orderId,
        method: 'DELETE',
        success: function() {
          showToast('success', 'Deleted', 'Order deleted successfully');
          loadAllOrders();
        },
        error: function() {
          showToast('error', 'Error', 'Failed to delete order');
        }
      });
    }
  }

  function toggleSidebar() {
    $('#sidebar').toggleClass('collapsed');
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      window.location.href = 'login.html';
    }
  }
</script>
</body>
</html>